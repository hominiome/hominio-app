name: Release

on:
  push:
    branches: [main]

jobs:
  # Run semantic-release (creates tag, GitHub release, and CHANGELOG automatically)
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-release
          token: ${{ secrets.GITHUB_TOKEN }} # Required for pushing tags
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install
      - name: Run semantic-release
        id: semantic-release
        run: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # After semantic-release runs, create release for the latest tag
      # This is a fallback in case @semantic-release/github plugin doesn't create releases
      - name: Create release for latest tag
        run: |
          echo "üîÑ Fetching tags from remote..."
          git fetch origin --tags --force
          
          # Get the latest tag (the one semantic-release just created)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "‚ö†Ô∏è  No tags found - semantic-release may not have created a release"
            exit 0
          fi
          
          echo "üìã Latest tag: $LATEST_TAG"
          
          # Extract release notes from CHANGELOG
          VERSION_NUM="${LATEST_TAG#v}"  # Remove 'v' prefix
          
          if [ -f services/app/CHANGELOG.md ]; then
            # Extract the section for this version from CHANGELOG.md
            NOTES=$(awk "/^## \[${VERSION_NUM}\]/,/^## \[/" services/app/CHANGELOG.md | sed '$d' || echo "")
            
            if [ -n "$NOTES" ] && [ "$NOTES" != "" ]; then
              echo "üìù Using CHANGELOG notes for $LATEST_TAG"
              echo "$NOTES" | gh release create "$LATEST_TAG" \
                --title "$LATEST_TAG" \
                --notes-file - \
                --target main
            else
              echo "üìù Generating release notes automatically for $LATEST_TAG"
              gh release create "$LATEST_TAG" \
                --title "$LATEST_TAG" \
                --generate-notes \
                --target main
            fi
          else
            echo "üìù Generating release notes automatically for $LATEST_TAG"
            gh release create "$LATEST_TAG" \
              --title "$LATEST_TAG" \
              --generate-notes \
              --target main
          fi
          
          echo "‚úÖ Release created for $LATEST_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
