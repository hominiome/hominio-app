name: Release

on:
  push:
    branches: [main]

jobs:
  # Run semantic-release (creates tag, GitHub release, and CHANGELOG automatically)
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-release
          token: ${{ secrets.GITHUB_TOKEN }} # Required for pushing tags
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install
      - name: Run semantic-release
        id: semantic-release
        run: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # After semantic-release runs, ensure release exists for any new tags
      # This is a fallback in case @semantic-release/github plugin doesn't create releases
      - name: Ensure releases exist for all tags
        run: |
          echo "üîÑ Fetching all tags from remote..."
          git fetch origin --tags --force
          
          # Get all tags, sorted by version
          ALL_TAGS=$(git tag -l 'v*' | sort -V)
          
          if [ -z "$ALL_TAGS" ]; then
            echo "‚ö†Ô∏è  No version tags found"
            exit 0
          fi
          
          echo "üìã Found tags:"
          echo "$ALL_TAGS"
          
          # Check each tag and create release if missing
          for TAG in $ALL_TAGS; do
            echo ""
            echo "üîç Checking tag: $TAG"
            
            # Check if release exists
            if gh release view "$TAG" &>/dev/null; then
              echo "‚úÖ Release already exists for $TAG"
            else
              echo "‚ö†Ô∏è  Release NOT found for $TAG - creating it..."
              
              # Extract release notes from CHANGELOG
              VERSION_NUM="${TAG#v}"  # Remove 'v' prefix
              
              if [ -f services/app/CHANGELOG.md ]; then
                # Extract the section for this version from CHANGELOG.md
                NOTES=$(awk "/^## \[${VERSION_NUM}\]/,/^## \[/" services/app/CHANGELOG.md | sed '$d' || echo "")
                
                if [ -n "$NOTES" ] && [ "$NOTES" != "" ]; then
                  echo "üìù Using CHANGELOG notes for $TAG"
                  echo "$NOTES" | gh release create "$TAG" \
                    --title "$TAG" \
                    --notes-file - \
                    --target main
                else
                  echo "üìù Generating release notes automatically for $TAG"
                  gh release create "$TAG" \
                    --title "$TAG" \
                    --generate-notes \
                    --target main
                fi
              else
                echo "üìù Generating release notes automatically for $TAG (no CHANGELOG)"
                gh release create "$TAG" \
                  --title "$TAG" \
                  --generate-notes \
                  --target main
              fi
              
              echo "‚úÖ Release created for $TAG"
            fi
          done
          
          echo ""
          echo "‚ú® Done checking all tags!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
